<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Receipt • LWG</title>

  <!-- prevent caching -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="stylesheet" href="css/styles.css"/>
  <style>
    :root{
      --bg:#0b1220; --panel:#0b1220; --muted:#94a3b8; --line:#1f2937;
      --btn:#111827; --btn-line:#1f2937; --btn-ok:#16a34a; --btn-ok-line:#15803d;
      --input-bg:#0f172a; --input-line:#374151; --text:#e5e7eb;
    }
    body{background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
    .card{max-width:860px;margin:24px auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px}
    .row{display:flex;gap:12px;margin:6px 0;flex-wrap:wrap;align-items:center}
    .items li{margin:4px 0}
    .muted{color:var(--muted)}
    .input{padding:10px;border-radius:10px;border:1px solid var(--input-line);background:var(--input-bg);color:var(--text);width:100%}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--btn-line);background:var(--btn);color:var(--text);cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn.good{background:var(--btn-ok);border-color:var(--btn-ok-line)}
    .btn.ghost{background:var(--input-bg);border:1px solid var(--input-line)}
    .timer{font-size:12px}
    .grow{flex:1;min-width:220px}
    .spin{width:16px;height:16px;border:2px solid #ffffff40;border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .err{color:#fca5a5}
    .ok{color:#86efac}
  </style>
</head>
<body>
  <div class="card" role="region" aria-labelledby="rcpt-h1">
    <h2 id="rcpt-h1">Order Receipt</h2>
    <p class="muted">Enter your <b>reference</b> and either your <b>phone</b> or <b>email</b> to view & download your receipt.</p>

    <form id="rcpt-form" class="row" novalidate>
      <label class="grow" for="ref" style="display:block">
        <span class="muted" style="display:block;margin-bottom:6px">Reference</span>
        <input id="ref" name="ref" class="input" placeholder="LWG-ABC123" autocomplete="off" required>
      </label>
      <label class="grow" for="who" style="display:block">
        <span class="muted" style="display:block;margin-bottom:6px">Phone or Email</span>
        <input id="who" name="who" class="input" placeholder="+232… or name@example.com" autocomplete="off" required>
      </label>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="findBtn" type="submit" class="btn" aria-live="polite">
          <span id="findTxt">Find</span>
          <span id="findSpin" class="spin" style="display:none" aria-hidden="true"></span>
        </button>
        <a id="dl" class="btn good" href="#" download style="display:none">Download PDF</a>
        <button id="close" type="button" class="btn ghost" style="display:none">Close now</button>
      </div>
    </form>

    <div id="msg" class="muted" style="margin-top:6px"></div>
    <div id="out" style="margin-top:12px"></div>
    <div id="timer" class="muted timer" style="display:none;margin-top:6px"></div>
  </div>

<script type="module">
/* ===== CONFIG (LIVE API) ===== */
const API = 'https://lwg-api.onrender.com';   // your Render backend
const AUTO_HIDE_MS = 7000;                     // receipt stays visible for 7s

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const money = n => 'NLe ' + Number(n||0).toLocaleString();
const isEmail = v => /\S+@\S+\.\S+/.test(v);
const normalizePhone = v => {
  const s = (v||'').trim();
  if (!s) return '';
  const digits = s.replace(/[^\d+]/g,'').replace(/^(\+)?/, '');
  return '+' + digits;
};

let hideTimer = null;
let tickTimer = null;

function btnLoading(on){
  const btn = $('#findBtn'), txt = $('#findTxt'), sp = $('#findSpin');
  btn.disabled = !!on;
  sp.style.display = on ? 'inline-block' : 'none';
  txt.textContent = on ? 'Finding…' : 'Find';
}

function say(text, cls='muted'){
  const el = $('#msg');
  el.className = cls;
  el.textContent = text || '';
}

function resetTransient(){
  if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
  if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
  $('#out').innerHTML = '';
  $('#timer').style.display = 'none';
  $('#timer').textContent = '';
  const dl = $('#dl'); dl.style.display = 'none'; dl.href = '#';
  $('#close').style.display = 'none';
  say('');
}

function clearAll(){
  resetTransient();
  $('#ref').value = '';
  $('#who').value = '';
  if (location.hash || location.search) history.replaceState(null, '', location.pathname);
}

function startAutoHide(){
  const started = Date.now();
  $('#timer').style.display = 'block';

  tickTimer = setInterval(() => {
    const left = Math.max(0, AUTO_HIDE_MS - (Date.now() - started));
    $('#timer').textContent = 'This page will clear in ' + Math.ceil(left/1000) + 's.';
    if (left <= 0) { clearInterval(tickTimer); tickTimer = null; }
  }, 250);

  hideTimer = setTimeout(() => {
    clearAll();
    $('#out').innerHTML = '<p class="muted">Receipt cleared.</p>';
  }, AUTO_HIDE_MS);

  $('#close').style.display = 'inline-flex';
}

function render(order){
  const items = (order.items||[]).map(i =>
    `<li>${escapeHtml(i.product.title)} × ${i.qty} — ${money(i.product.price)}</li>`).join('');
  $('#out').innerHTML = `
    <div class="row"><div><b>Reference</b></div><div>${escapeHtml(order.ref)}</div></div>
    <div class="row"><div><b>Date</b></div><div>${new Date(order.createdAt).toLocaleString()}</div></div>
    <div class="row"><div><b>Status</b></div><div>${escapeHtml(order.status)}</div></div>
    <div class="row"><div><b>Payment</b></div><div>${escapeHtml(order.paymentStatus)}</div></div>
    <div class="row"><div><b>Name</b></div><div>${escapeHtml(order.info?.name||'')}</div></div>
    <div class="row"><div><b>Delivery</b></div><div>${escapeHtml(order.info?.deliveryZone||'')}</div></div>
    <div class="row"><div><b>Total</b></div><div><b>${money(order.info?.grandTotal ?? order.info?.subtotal ?? 0)}</b></div></div>
    <div style="margin-top:8px"><b>Items</b><ul class="items">${items}</ul></div>
  `;
}

function escapeHtml(s=''){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function fetchOrder(ref, whoRaw){
  const who = whoRaw.trim();
  const qs = new URLSearchParams({ ref });

  if (isEmail(who)) qs.set('email', who);
  else qs.set('phone', normalizePhone(who));

  const r = await fetch(`${API}/api/orders/track?${qs}`, { cache:'no-store' });

  // Friendly error mapping
  if (!r.ok){
    let reason = r.statusText || 'Request failed';
    try {
      const j = await r.json();
      if (j && j.error) reason = j.error;
    } catch {}
    if (r.status === 404) throw new Error('Order not found. Check your reference and contact.');
    if (r.status === 429) throw new Error('Too many tries. Please wait a minute and try again.');
    if (r.status === 503) throw new Error('Service temporarily unavailable. Please try again later.');
    throw new Error(reason);
  }

  const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
  if (!j.ok) throw new Error(j.error || 'Unknown error');
  return { order: j.order, qs };
}

/* ===== Submit handler ===== */
$('#rcpt-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const ref = $('#ref').value.trim();
  const who = $('#who').value.trim();

  try {
    if (!ref || !who) throw new Error('Enter both fields');
    btnLoading(true);
    resetTransient();
    say('Looking up your order…');

    const { order, qs } = await fetchOrder(ref, who);
    render(order);
    say('Found your order ✔', 'ok');

    const dl = $('#dl');
    dl.href = `${API}/api/orders/receipt.pdf?${qs}`;
    dl.style.display = 'inline-flex';

    history.replaceState(null, '', location.pathname);
    startAutoHide();
  } catch (err) {
    say(String(err.message || err), 'err');
  } finally {
    btnLoading(false);
  }
});

/* manual close */
$('#close').addEventListener('click', clearAll);

/* clear if restored from bfcache */
window.addEventListener('pageshow', (e) => { if (e.persisted) clearAll(); });

/* clear on history nav */
window.addEventListener('popstate', clearAll);

/* deep link: receipt.html#LWG-XXX|+2327..orEmail */
(function bootFromHash(){
  if (location.hash.includes('|')) {
    const [ref, who] = decodeURIComponent(location.hash.slice(1)).split('|');
    $('#ref').value = (ref||'').trim();
    $('#who').value = (who||'').trim();
    history.replaceState(null, '', location.pathname);
    $('#rcpt-form').dispatchEvent(new Event('submit', {cancelable:true}));
  }
})();
</script>
</body>
</html>
